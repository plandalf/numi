<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plandalf Session API Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .log { 
            background: #0f172a; 
            color: #22c55e; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace; 
            height: 250px; 
            overflow-y: auto; 
            margin: 15px 0;
            font-size: 13px;
            line-height: 1.4;
            border: 1px solid #1e293b;
        }
        button { 
            padding: 10px 20px; 
            margin: 6px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            font-size: 14px;
            transition: all 0.15s;
        }
        button:hover { transform: translateY(-1px); }
        .popup { background: #3b82f6; color: white; }
        .standard { background: #10b981; color: white; }
        .slider { background: #f59e0b; color: white; }
        .test { background: #8b5cf6; color: white; }
        .clear { background: #ef4444; color: white; font-size: 12px; padding: 6px 12px; }
        h1 { color: #1e293b; text-align: center; margin-bottom: 20px; font-size: 24px; }
        h2 { color: #334155; font-size: 18px; margin-bottom: 15px; }
        .status { padding: 8px 12px; border-radius: 4px; margin: 10px 0; font-size: 14px; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .stats { display: flex; gap: 10px; margin: 15px 0; }
        .stat { background: #f1f5f9; padding: 8px 12px; border-radius: 4px; text-align: center; flex: 1; }
        .stat-value { font-size: 18px; font-weight: bold; color: #1e293b; }
        .stat-label { font-size: 12px; color: #64748b; }
        .buttons { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        code { background: #f1f5f9; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>
    <h1>üöÄ Plandalf Session API Test Page</h1>
    
    <div class="container">
        <div class="status info">
            <strong>Status:</strong> <span id="status">Loading...</span>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="activeSessions">0</div>
                <div class="stat-label">Active Sessions</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="completedSessions">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="cancelledSessions">0</div>
                <div class="stat-label">Cancelled</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalEvents">0</div>
                <div class="stat-label">Total Events</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üìã Event Log</h2>
        <div class="log" id="log"></div>
        <button onclick="clearLog()" class="clear">Clear Log</button>
    </div>

    <div class="container">
        <h2>üß™ Embed Type Tests</h2>
        <p>Test different embed types using offer: <code>bing-bong-1-8Di1dEf1LTe</code></p>
        
        <div class="buttons">
            <button 
                data-numi-popup-size="large" 
                data-numi-offer="payments-example-VSfZ8ZeG5jz/test" 
                data-numi-embed-type="popup"
                class="popup">
                Popup (Large)
            </button>
            
            <button 
                data-numi-popup-size="medium" 
                data-numi-offer="bing-bong-1-8Di1dEf1LTe" 
                data-numi-embed-type="popup"
            
                class="popup">
                Popup (Medium)
            </button>
            
            <button 
                data-numi-popup-size="small" 
                data-numi-offer="bing-bong-1-8Di1dEf1LTe" 
                data-numi-embed-type="popup"
                class="popup">
                Popup (Small)
            </button>
            
            <!-- <button 
                data-numi-offer="bing-bong-1-8Di1dEf1LTe" 
                data-numi-embed-type="standard"
                class="standard">
                Standard Embed
            </button> -->
            
            <button 
                data-numi-slider-direction="right" 
                data-numi-offer="bing-bong-1-8Di1dEf1LTe" 
                data-numi-embed-type="slider"
                class="slider">
                Slider (Right)
            </button>
            
            <button 
                data-numi-slider-direction="left" 
                data-numi-offer="bing-bong-1-8Di1dEf1LTe" 
                data-numi-embed-type="slider"
                class="slider">
                Slider (Left)
            </button>
        </div>
    </div>

    <div class="container">
        <h2>‚ö° Session API Tests</h2>
        <div class="buttons">
            <button onclick="testSessionTracking()" class="test">Session Tracking</button>
            <button onclick="testPromiseAPI()" class="test">Promise API</button>
            <button onclick="waitForAnyPurchase()" class="test">Wait for Purchase</button>
            <button onclick="testWildcardMatching()" class="test">Wildcard Matching</button>
            <button onclick="testAnalyticsSetup()" class="test">Analytics Setup</button>
            <button onclick="testSessionState()" class="test">Session State</button>
        </div>
    </div>

    <div class="container">
        <h2>üßæ Billing Portal Test</h2>
        <p>This button opens the billing portal. In local dev, it will auto-fetch a test JWT and attach it.</p>
        <div class="buttons">
            <button
                id="billingPortalButton"
                data-numi-embed-type="billing-portal"
                data-numi-portal="billing"
                data-numi-button-text="Open Billing Portal"
                class="popup"
            >
                Billing Portal (Popup)
            </button>
        </div>
        <div class="status info" id="billingPortalStatus">Waiting for token‚Ä¶</div>
    </div>

    <div class="container">
        <h2>üßæ Billing Portal Test (Provided Token)</h2>
        <p>Uses a hardcoded token via <code>data-numi-customer</code>.</p>
        <div class="buttons">
            <button
                data-numi-embed-type="billing-portal"
                data-numi-portal="billing"
                data-numi-customer="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjdXN0b21lcl9pZCI6ImN1c19Tb1oydlZUOTZ4cXFVMyIsImlhdCI6MTc1NDcwOTU2MSwiZXhwIjoxNzU0NzEzMTYxfQ.OUIfZZge0eCFAxqy_g-m4bpF6TqI3iGBGdVrNxIPprY"
                data-numi-button-text="Open Billing Portal (Provided Token)"
                class="popup"
            >
                Billing Portal (Provided Token)
            </button>
        </div>
    </div>

    <script>
        // =============================================================================
        // TEST UTILITIES
        // =============================================================================
        
        let stats = {
            activeSessions: 0,
            completedSessions: 0,
            cancelledSessions: 0,
            totalEvents: 0
        };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            logDiv.innerHTML += `<div>[${time}] ${emoji} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            stats.totalEvents++;
            updateStats();
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            stats.totalEvents = 0;
            updateStats();
        }
        
        function updateStats() {
            document.getElementById('activeSessions').textContent = stats.activeSessions;
            document.getElementById('completedSessions').textContent = stats.completedSessions;
            document.getElementById('cancelledSessions').textContent = stats.cancelledSessions;
            document.getElementById('totalEvents').textContent = stats.totalEvents;
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        // =============================================================================
        // PLANDALF CONFIG (runs before script loads)
        // =============================================================================
        
        window.plandalfConfig = {
            // Global event handlers
            onInit: function(data) {
                log(`üöÄ Session started: ${data.sessionId}`, 'info');
                stats.activeSessions++;
                updateStats();
            },
            
            onSuccess: function(data) {
                log(`üí∞ Payment succeeded: ${data.orderNumber || 'N/A'}`, 'success');
            },
            
            onComplete: function(data) {
                log(`‚úÖ Session completed: ${data.orderNumber || 'N/A'}`, 'success');
                stats.activeSessions = Math.max(0, stats.activeSessions - 1);
                stats.completedSessions++;
                updateStats();
            },
            
            onCancel: function(data) {
                log(`‚ùå Session cancelled: ${data.cancelReason}`, 'error');
                stats.activeSessions = Math.max(0, stats.activeSessions - 1);
                stats.cancelledSessions = (stats.cancelledSessions || 0) + 1;
                updateStats();
            },
            
            onLineItemChange: function(data) {
                const changeTypeEmoji = {
                    'added': '‚ûï',
                    'removed': '‚ûñ', 
                    'quantity_changed': 'üî¢',
                    'price_changed': 'üí∞'
                };
                log(`${changeTypeEmoji[data.changeType] || 'üõí'} Cart updated: ${data.changeType} - Total: ${data.newTotal || 'N/A'} ${data.currency || ''}`, 'info');
            },
            
            onClosed: function(data) {
                const statusEmoji = data.wasCompleted ? '‚úÖ' : 'üö™';
                log(`${statusEmoji} ${data.embedType} closed - Completed: ${data.wasCompleted}`, data.wasCompleted ? 'success' : 'warning');
            },
            
            // Specific offer configuration
            offers: {
                'bing-bong-1-8Di1dEf1LTe': {
                    onComplete: function(data) {
                        log('üéâ Offer completed successfully!', 'success');
                        setTimeout(() => log('‚ú® Features activated!', 'success'), 800);
                    }
                }
            }
        };

        // =============================================================================
        // PROGRAMMATIC API TESTS
        // =============================================================================
        
        async function testPromiseAPI() {
            try {
                log('üîÑ Testing Promise API - waiting for any checkout...', 'info');
                
                const checkout = await plandalf.offers.get('*').onCheckout();
                log(`üéØ Promise API: Caught session ${checkout.id} for ${checkout.offerId}`, 'success');
                
                const result = await checkout.waitForCompletion();
                log(`üéâ Promise API: Session completed successfully!`, 'success');
                
            } catch (error) {
                log(`‚ö†Ô∏è Promise API test cancelled: ${error.message}`, 'warning');
            }
        }
        
        async function testSessionTracking() {
            log('üìã Setting up detailed session tracking...', 'info');
            
            plandalf.offers.get('*').onCheckout((checkout) => {
                log(`üìä Session Tracker: Monitoring ${checkout.id}`, 'info');
                
                checkout
                    .onPageChange((data) => {
                        log(`üìÑ Session ${checkout.id}: Page changed to ${data.pageId}`, 'info');
                    })
                    .onSubmit((data) => {
                        log(`üì§ Session ${checkout.id}: Payment submitted`, 'info');
                    })
                    .onResize((data) => {
                        log(`üìè Session ${checkout.id}: Form resized to ${data.size}px`, 'info');
                    });
            });
            
            log('‚úÖ Session tracking active!', 'success');
        }
        
        async function testWildcardMatching() {
            log('üîç Testing wildcard pattern matching...', 'info');
            
            // Test bing-bong wildcard
            plandalf.offers.get('bing-bong-*').onCheckout((checkout) => {
                log(`üéØ Wildcard matched: ${checkout.offerId}`, 'success');
            });
            
            // Test universal wildcard
            plandalf.offers.get('*').onCheckout((checkout) => {
                log(`‚≠ê Universal wildcard matched: ${checkout.offerId}`, 'success');
            });
            
            log('‚úÖ Wildcard listeners active!', 'success');
        }
        
        function testAnalyticsSetup() {
            log('üìà Setting up analytics tracking...', 'info');
            
            plandalf.offers.get('*').onCheckout((checkout) => {
                log(`üìä Analytics: Tracking session ${checkout.id}`, 'info');
                
                checkout
                    .onInit((data) => {
                        log(`üìà Analytics: begin_checkout for ${checkout.offerId}`, 'info');
                        // gtag('event', 'begin_checkout', { checkout_id: checkout.id });
                    })
                    .onSubmit((data) => {
                        log(`üìà Analytics: add_payment_info for ${checkout.id}`, 'info');
                        // gtag('event', 'add_payment_info', { checkout_id: checkout.id });
                    })
                    .onSuccess((data) => {
                        log(`üìà Analytics: purchase event for ${data.orderNumber}`, 'success');
                        // gtag('event', 'purchase', { transaction_id: data.orderNumber });
                    });
            });
            
            log('‚úÖ Analytics tracking setup complete!', 'success');
        }

        async function waitForAnyPurchase() {
            try {
                log('‚è≥ Waiting for any purchase to complete...', 'info');
                
                const result = await plandalf.offers.get('*').onAnyComplete();
                
                log(`üéâ Purchase completed!`, 'success');
                log(`üì¶ Offer: ${result.session.offerId}`, 'info');
                log(`üÜî Order: ${result.orderNumber || 'N/A'}`, 'info');
                log(`‚è±Ô∏è Duration: ${result.sessionDuration}ms`, 'info');
                
            } catch (error) {
                log(`‚ö†Ô∏è No purchases completed: ${error.message}`, 'warning');
            }
        }
        
        async function testSessionState() {
            try {
                log('üîç Testing session state tracking...', 'info');
                
                const checkout = await plandalf.offers.get('*').onCheckout();
                log(`üìã Monitoring session state for ${checkout.id}`, 'info');
                
                // Monitor state changes
                const interval = setInterval(() => {
                    const state = checkout.getState();
                    log(`üìä State: ${state.events.length} events, Active: ${state.isActive}`, 'info');
                    
                    if (!state.isActive) {
                        clearInterval(interval);
                        log(`üìà Final state: ${JSON.stringify(state, null, 2)}`, 'success');
                    }
                }, 2000);
                
            } catch (error) {
                log(`‚ö†Ô∏è Session state test cancelled: ${error.message}`, 'warning');
            }
        }

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('Waiting for plandalf.js to load...');
            
            const checkPlandalf = () => {
                if (window.plandalf) {
                    updateStatus('‚úÖ Ready');
                    log('üéØ Test page ready! Click buttons to test.', 'success');
                } else {
                    setTimeout(checkPlandalf, 100);
                }
            };
            
            checkPlandalf();
        });
    </script>

    <script>
        // Attempt to fetch a local test token and attach it before v1.js initializes embeds
        (async function attachBillingTestToken() {
            try {
                const res = await fetch('/dev/billing/test-token');
                if (!res.ok) throw new Error('non-200');
                const data = await res.json();
                const btn = document.getElementById('billingPortalButton');
                if (btn && data && data.token) {
                    btn.setAttribute('data-numi-customer', data.token);
                    const status = document.getElementById('billingPortalStatus');
                    if (status) {
                        status.textContent = '‚úÖ Test token attached. Click the button to open the portal.';
                    }
                    // Log for visibility
                    if (window.console) {
                        console.log('[Billing Test] token:', data.token);
                        console.log('[Billing Test] example_url:', data.example_url);
                    }
                } else {
                    const status = document.getElementById('billingPortalStatus');
                    if (status) status.textContent = '‚ö†Ô∏è No token available (not local or no ApiKey). You can still open the portal without a token.';
                }
            } catch (e) {
                const status = document.getElementById('billingPortalStatus');
                if (status) status.textContent = '‚ö†Ô∏è Token fetch failed. You can still open the portal without a token.';
            }
        })();
    </script>
    <!-- Load the enhanced v1.js script -->
    <script src="./js/v1.js"></script>
</body>
</html>